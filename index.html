<!DOCTYPE HTML>
<html>

<head>


    <meta charset="utf-8">
    <link href="playing_cards/cards.css" rel="stylesheet">
    <title>BS Poker</title>

    <script type="text/javascript" src="src/error.js"></script>

    <script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
    <script type="text/javascript" src="playing_cards/Card.js"></script>
    <script type="text/javascript" src="src/cookies.js"></script>
    <script type="text/javascript" src="src/firebase.js"></script>
    <script type="text/javascript" src="src/User.js"></script>
    <script type="text/javascript" src="src/dealer.js"></script>


    <style>
        td {text-align: center;}
        .playerCards { top:25%; }
    </style>


    <script>
        checkCookie();
        openFirebase();
        var username = getCookie ("username");
        //console.log (username+ " Gobly Gook");
        updateConnection (username);
        var user = new User (username);
        var maxcards = 6;
        var maxplayers = 8;
        var cardsinhand = 0;
        var allusers = [];
    </script>

    <script>
        function translateToCards (hand) {
            var cards = [];
            for (var i = 0; i < hand.length; i++) {
                cards.push (new Card (hand[i].substring(0, hand[i].length-1), hand[i].substring(hand[i].length-1)));
            }
            return cards;
        }
    </script>


    <script>
        function updateCards () {
            cardsinhand = 0;
            var stringhand = user.getHand();
            var newhand = [];
            if (typeof stringhand != "undefined") {
                newhand = translateToCards(stringhand);
            }
            else {

            }
            var element = [];
            for (var i = 0; i < maxcards; i++) {
                element.push(document.getElementById("card" + i));
                //element[i].removeChild(element[i].childNodes[0]);
                while (element[i].firstChild) {
                    element[i].removeChild(element[i].firstChild);
                }
                if (newhand[i] == "" || i >= newhand.length) {
                    var node = document.createTextNode("");
                    element[i].appendChild(node);
                }
                else {
                    element[i].appendChild(newhand[i].createNode());
                    cardsinhand++;
                }
            }
        }
    </script>

    <script>
        function updateStoppage () {
            var call;
            readFirebase("call", function(snapshot){
                call = snapshot.val().currentCall;
                var node = document.createTextNode (call);
                var element = document.getElementById("call1");
                while (element.firstChild) {
                    element.removeChild(element.firstChild);
                }
                element.appendChild (node);
            });
            if (call == "" && cardsinhand > 0) {
                document.getElementById("BSButton").style.visibility = "visible";
                document.getElementById("SpotButton").style.visibility = "visible";
                clearCards ();
            }
            else {
                document.getElementById("BSButton").style.visibility = "hidden";
                document.getElementById("SpotButton").style.visibility = "hidden";
                getEveryCard();
                setDealerVisibility();
            }
        }
    </script>

    <script>
        function callBS () {
            writeFirebase("call", {currentCall:username+" called BS"});
        }
        function callSPOTON () {
            writeFirebase("call", {currentCall:username+" called SPOT ON"});
        }
    </script>

    <script>
        function getEveryCard () {
            var cardtotal = 0;
            for (var i = 0; i < maxplayers; i++) {
                var tempdoc = document.getElementById("user" + i);
                if (tempdoc != null) {
                    var text = tempdoc.textContent;
                    if (text.indexOf(':') != -1) {
                        //console.log (text);
                        var handsize;
                        var tempusername = text.substring(0, text.indexOf(':') - 1);
                        //console.log(tempusername);
                        readFirebase("users/" + tempusername, function (snapshot) {
                            var playerhands = snapshot.val().hand;
                            handsize = numCards(playerhands);
                            var cardhand = translateToCards(playerhands);
                            for (var cardnum = 0; cardnum < handsize; cardnum++) {
                                var myNode = document.getElementById("card0" + cardtotal);
                                while (myNode.firstChild) {
                                    myNode.removeChild(myNode.firstChild);
                                }
                                myNode.appendChild(cardhand[cardnum].createNode());
                                cardtotal++;
                            }
                        });
                    }
                    else {
                        while (tempdoc.firstChild) {
                            tempdoc.removeChild(tempdoc.firstChild);
                        }
                    }
                }
            }
            while (cardtotal < 52) {
                var myNode = document.getElementById("card0" + i);
                while (myNode.firstChild) {
                    myNode.removeChild(myNode.firstChild);
                }
                cardtotal++;
            }
        }
    </script>

    <script>
        function clearCards () {
            for (var cardtotal = 0; cardtotal < 52; cardtotal++) {
                var myNode = document.getElementById("card0" + cardtotal);
                while (myNode.firstChild) {
                    console.log (myNode.firstChild);
                    myNode.removeChild(myNode.firstChild);
                }
            }
        }
    </script>




    <script>
        function checkConnections () {
            allusers = [];
            readFirebase ("online/", function (snapshot) {
                var snap = snapshot.val().currentusers;
                var i = 0;
                for (k in snap) {
                    //console.log (k);
                    //console.log (snap[k]);
                    if (snapshot.val().currentusers[k] == true) {
                        allusers.push(k);
                        var myNode = document.getElementById("user" + i);
                        while (myNode.firstChild) {
                            myNode.removeChild(myNode.firstChild);
                        }
                        myNode.appendChild(document.createTextNode(k + " : "));
                        i++;
                    }
                }
                while (i < maxplayers) {
                    var myNode = document.getElementById("user" + i);
                    while (myNode.firstChild) {
                        myNode.removeChild(myNode.firstChild);
                    }
                    i++;
                }
            });
            checkEveryCard();
        }
    </script>

    <script>
        // Error in here
        function checkEveryCard () {
            for (var i = 0; i < maxplayers; i++) {
                var tempdoc = document.getElementById("user" + i);
                if (tempdoc != null) {
                    var text = tempdoc.textContent;
                    if (text.indexOf(':') != -1) {
                        //console.log (text);
                        var handsize;
                        var tempusername = text.substring(0, text.indexOf(':') - 1);
                        //console.log(tempusername);
                        readFirebase("users/" + tempusername, function (snapshot) {
                            var playerhands = snapshot.val().hand;
                            handsize = numCards(playerhands);
                            while (tempdoc.firstChild) {
                                tempdoc.removeChild(tempdoc.firstChild);
                            }
                            tempdoc.appendChild(document.createTextNode(tempusername + " : " + handsize));
                        });
                    }
                    else {
                        while (tempdoc.firstChild) {
                            tempdoc.removeChild(tempdoc.firstChild);
                        }
                    }
                }
            }
        }
    </script>

    <script>
        function numCards (hand) {
            var total = 0;
            for (d in hand) {
                if (hand[d].replace(/\s/g, '') != "") {
                    total++;
                }
            }
            return total;
        }
    </script>

    <script>
        var deck, cards;
        deck = new Stack();
        deck.makeDeck(1);
        deck.shuffle(1);
        cards = [];
        for (var i = 0; i < 4; i++)
        {
            cards.push (deck.deal().toString());
        }
        var dict = { hand: cards };
        writeFirebase ("users/"+username, dict);
    </script>


    <script>
        //listens for when the values in dealer are changed
        firebase.database().ref("dealer").on("value", function(dataSnapshot){
            checkDealer ();
        });
    </script>


    <script>
        function getSelectedOption(sel) {
            var opt;
            for ( var i = 0; i < sel.options.length; i++ ) {
                opt = sel.options[i];
                if ( opt.selected === true ) {
                    break;
                }
            }
            return opt;
        }
    </script>

    <script>
        function resetCall () { writeFirebase("call", {currentCall:""}); }
    </script>

</head>

<body>

<h1 width="100"> BS Poker </h1> <!-- header-->

<!-- other players-->

<table width="100%" padding="10">
    <tr>

        <td id="user0" width="12.5%"></td>
        <td id="user1" width="12.5%"></td>
        <td id="user2" width="12.5%"></td>
        <td id="user3" width="12.5%"></td>
        <td id="user4" width="12.5%"></td>
        <td id="user5" width="12.5%"></td>
        <td id="user6" width="12.5%"></td>
        <td id="user7" width="12.5%"></td>

    </tr>
</table>

<table width="100%" padding="10" id="dealer">
    <tr>

        <td width="12.5%">
            <select id="playercards0">
                <option value="6">6</option>
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
            </select>
        </td>
        <td width="12.5%">
            <select id="playercards1">
                <option value="6">6</option>
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
            </select>
        </td>
        <td width="12.5%">
            <select id="playercards2">
                <option value="6">6</option>
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
            </select>
        </td>
        <td width="12.5%">
            <select id="playercards3">
                <option value="6">6</option>
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
            </select>
        </td>
        <td width="12.5%">
            <select id="playercards4">
                <option value="6">6</option>
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
            </select>
        </td>
        <td width="12.5%">
            <select id="playercards5" >
                <option value="6">6</option>
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
            </select>
        </td>
        <td width="12.5%">
            <select id="playercards6" >
                <option value="6">6</option>
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
            </select>
        </td>
        <td width="12.5%">
            <select id="playercards7" >
                <option value="6">6</option>
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
            </select>
        </td>

    </tr>

    <script>
        for (var i = 0; i < maxplayers; i++) {
            document.getElementById('playercards'+i).value=4;
        }
    </script>
</table>


<div>
    <button type="button" onclick="dealCards()" id="DealCards">  Deal Cards </button>
</div>

<script>
    setDealerVisibility();

</script>

<script>
    checkConnections();
</script>

<script>
    var u = setInterval(checkConnections,30);
    //var v = setInterval(checkEveryCard,30);
</script>

<!-- end other players-->
<hr/>

<!--current call bar -->

<div>
    <table width="100%">
        <form> <!-- <tr> -->

            <td>
                <h1>
                   <!-- CURRENT CALL -->
                    <script>
                        document.write (username);
                    </script>
                </h1>
            </td>
            <td id="call1">

            </td>
            <script>
                //updateStoppage();
                var y = setInterval(updateStoppage,100);
                //clearInterval(y);
            </script>
            <td>
                <form>
                    <td>
                        <button type="button" onclick="callBS()" id="BSButton">  BS </button>
                    </td>
                    <td>
                        <button type="button" onclick="callSPOTON()" id="SpotButton"> SPOT ON </button>
                    </td>

                </form>
            </td>
        <tr>

    </table>
</div>

<!--end -->


<div>
    <table width="100%">
        <tr>

            <td id="card0"></td>
            <td id="card1"></td>
            <td id="card2"></td>
            <td id="card3"></td>
            <td id="card4"></td>
            <td id="card5"></td>

            <script>
                updateCards();
            </script>

            <script>
                var t = setInterval(updateCards,1000);
                //clearInterval(t);
            </script>

        </tr>


    </table>
</div>

<!-- Everyone's cards -->
<div style="clear:both" id="playerCards">
    <table width="100%">
        <tr>

            <td id="card00"></td><td id="card01"></td>
            <td id="card02"></td><td id="card03"></td>
            <td id="card04"></td><td id="card05"></td>
            <td id="card06"></td><td id="card07"></td>
            <td id="card08"></td><td id="card09"></td>
            <td id="card010"></td><td id="card011"></td>
            <td id="card012"></td><td id="card013"></td>
            <td id="card014"></td><td id="card015"></td>
            <td id="card016"></td><td id="card017"></td>
            <td id="card018"></td><td id="card019"></td>
            <td id="card020"></td><td id="card021"></td>
            <td id="card022"></td><td id="card023"></td>
            <td id="card024"></td><td id="card025"></td>
            <td id="card026"></td><td id="card027"></td>
            <td id="card028"></td><td id="card029"></td>
            <td id="card030"></td><td id="card031"></td>
            <td id="card032"></td><td id="card033"></td>
            <td id="card034"></td><td id="card035"></td>
            <td id="card036"></td><td id="card037"></td>
            <td id="card038"></td><td id="card039"></td>
            <td id="card040"></td><td id="card041"></td>
            <td id="card042"></td><td id="card043"></td>
            <td id="card044"></td><td id="card045"></td>
            <td id="card046"></td><td id="card047"></td>
            <td id="card048"></td><td id="card049"></td>
            <td id="card050"></td><td id="card051"></td>


        </tr>


    </table>
   
</div>


</body>





