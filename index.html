<!DOCTYPE HTML>
<html>

<head>


    <meta charset="utf-8">
    <link href="playing_cards/cards.css" rel="stylesheet">
    <title>BS Poker</title>

    <script type="text/javascript" src="src/error.js"></script>

    <script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
    <script type="text/javascript" src="playing_cards/Card.js"></script>
    <script type="text/javascript" src="src/cookies.js"></script>
    <script type="text/javascript" src="src/firebase.js"></script>
    <script type="text/javascript" src="src/User.js"></script>



    <style>
        td {text-align: center;}
    </style>


    <script>
        checkCookie();
        openFirebase();
        var username = getCookie ("username");
        console.log (username+ " Gobly Gook");
        updateConnection (username);
        var user = new User (username);
        var maxcards = 6;
        var maxplayers = 8;
        var cardsinhand = 0;
        var allusers = [];
    </script>

    <script>
        function translateToCards (hand) {
            var cards = [];
            for (var i = 0; i < hand.length; i++) {
                cards.push (new Card (hand[i].substring(0, hand[i].length-1), hand[i].substring(hand[i].length-1)));
            }
            return cards;
        }
    </script>


    <script>
        function updateCards () {
            cardsinhand = 0;
            var stringhand = user.getHand();
            var newhand;
            if (typeof stringhand != "undefined") {
                newhand = translateToCards(stringhand);
            }
            else {
            }
            var element = [];
            for (var i = 0; i < maxcards; i++) {

                element.push(document.getElementById("card" + i));
                element[i].removeChild(element[i].childNodes[0]);
                if (newhand[i] == "" || i >= newhand.length) {
                    var node = document.createTextNode("");
                    element[i].appendChild(node);
                }
                else {
                    element[i].appendChild(newhand[i].createNode());
                    cardsinhand++;
                }
            }
        }
    </script>

    <script>
        function updateStoppage () {
            var call;
            readFirebase("call", function(snapshot){
                call = snapshot.val().currentCall;
            });
            var node = document.createTextNode (call);
            var element = document.getElementById("call1");
            element.removeChild(element.childNodes[0]);
            element.appendChild (node);
            if (call == "" && cardsinhand > 0) {
                document.getElementById("BSButton").style.visibility = "visible";
                document.getElementById("SpotButton").style.visibility = "visible";
            }
            else {
                document.getElementById("BSButton").style.visibility = "hidden";
                document.getElementById("SpotButton").style.visibility = "hidden";
            }
        }
    </script>

    <script>
        function callBS () {
            writeFirebase("call", {currentCall:username+" called BS"});
        }
        function callSPOTON () {
            writeFirebase("call", {currentCall:username+" called SPOT ON"});
        }
    </script>



    <script>
        function checkConnections () {
            allusers = [];
            readFirebase ("online/", function (snapshot) {
                var i = 0;
                for (k in snapshot.val().online) {
                    allusers.push (k);
                    document.getElementById("user"+i).replaceChild(document.createTextNode(k+" : "),
                            document.getElementById("user"+i).childNodes[0]);
                    i++;
                }
            });
        }
    </script>

    <script>
        // Error in here
        function checkEveryCard () {
            for (var i = 0; i < maxplayers; i++) {
                var tempdoc = document.getElementById("user" + i);
                if (tempdoc != null) {

                    var text = tempdoc.textContent;
                    if (text.replace(/\s/g, '') != "" && text.indexOf(':') != -1) {
                        var handsize;

                        var username = text.substring(0, text.indexOf(':') - 1);
                        console.log(username);
                        readFirebase("users/" + username, function (snapshot) {
                            var playerhands = snapshot.val().hand;
                            handsize = numCards(playerhands);
                            while (tempdoc.firstChild) {
                                tempdoc.removeChild(tempdoc.firstChild);
                            }
                            tempdoc.appendChild(document.createTextNode(substr + " : " + handsize));
                        });
                    }
                }
            }
        }
    </script>

    <script>
        function numCards (hand) {
            var total = 0;
            for (d in hand) {
                if (hand[d].replace(/\s/g, '') != "") {
                    total++;
                }
            }
            return total;
        }
    </script>
    <script>

        var deck, card1, card2;
        deck = new Stack();
        deck.makeDeck(1);
        deck.shuffle(1);

        card1 = deck.deal().toString();
        card2 = deck.deal().toString();
        var cards = [card1, card2];
        var dict = { hand: cards};
        writeFirebase ("users/"+username, dict);

    </script>




</head>

<body>

<h1 width="100"> BS Poker </h1> <!-- header-->

<!-- other players-->

<table width="100%" padding="10">
    <tr>

        <td id="user0" width="12.5%">  </td>
        <td id="user1" width="12.5%">  </td>
        <td id="user2" width="12.5%">  </td>
        <td id="user3" width="12.5%">  </td>
        <td id="user4" width="12.5%">  </td>
        <td id="user5" width="12.5%">  </td>
        <td id="user6" width="12.5%">  </td>
        <td id="user7" width="12.5%">  </td>

    </tr>
</table>


<script>
    checkConnections();
</script>

<script>
    var u = setInterval(checkEveryCard,5000);
</script>

<!-- end other players-->
<hr/>

<!--current call bar -->

<div>
    <table width="100%">
        <form> <!-- <tr> -->

            <td>
                <h1>
                   <!-- CURRENT CALL -->
                    <script>
                        document.write (username);
                    </script>
                </h1>
            </td>
            <td id="call1">

            </td>
            <script>
                var y = setInterval(updateStoppage,100);
                //clearInterval(y);
            </script>
            <td>
                <form>
                    <td>
                        <button type="button" onclick="callBS()" id="BSButton">  BS </button>
                    </td>
                    <td>
                        <button type="button" onclick="callSPOTON()" id="SpotButton"> SPOT ON </button>
                    </td>

                </form>
            </td>
        <tr>

    </table>
</div>

<!--end -->


<div>
    <table width="100%">
        <tr>

            <td id="card0">
            </td>
            <td id="card1">
            </td>
            <td id="card2">
            </td>
            <td id="card3">
            </td>
            <td id="card4">

            </td>
            <td id="card5">

            </td>

            <script>
                updateCards();
            </script>

            <script>

                var t = setInterval(updateCards,1000);
                //clearInterval(t);
            </script>

        </tr>


    </table>

    <script>

    </script>
</div>


</body>





</html>