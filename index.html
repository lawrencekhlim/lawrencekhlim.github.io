<!DOCTYPE HTML>
<html>

<head>


    <meta charset="utf-8">
    <link href="playing_cards/cards.css" rel="stylesheet">
    <title>BS Poker</title>

    <script type="text/javascript" src="src/error.js"></script>

    <script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
    <script type="text/javascript" src="playing_cards/Card.js"></script>
    <script type="text/javascript" src="src/cookies.js"></script>
    <script type="text/javascript" src="src/firebase.js"></script>
    <script type="text/javascript" src="src/User.js"></script>



    <style>
        td {text-align: center;}
    </style>


    <script>
        checkCookie();
        openFirebase();
        var username = getCookie ("username");
        //console.log (username+ " Gobly Gook");
        updateConnection (username);
        var user = new User (username);
        var maxcards = 6;
        var maxplayers = 8;
        var cardsinhand = 0;
        var allusers = [];
    </script>

    <script>
        function translateToCards (hand) {
            var cards = [];
            for (var i = 0; i < hand.length; i++) {
                cards.push (new Card (hand[i].substring(0, hand[i].length-1), hand[i].substring(hand[i].length-1)));
            }
            return cards;
        }
    </script>


    <script>
        function updateCards () {
            cardsinhand = 0;
            var stringhand = user.getHand();
            var newhand;
            if (typeof stringhand != "undefined") {
                newhand = translateToCards(stringhand);
            }
            else {
            }
            var element = [];
            for (var i = 0; i < maxcards; i++) {

                element.push(document.getElementById("card" + i));
                //element[i].removeChild(element[i].childNodes[0]);
                while (element[i].firstChild) {
                    element[i].removeChild(element[i].firstChild);
                }
                if (newhand[i] == "" || i >= newhand.length) {
                    var node = document.createTextNode("");
                    element[i].appendChild(node);
                }
                else {
                    element[i].appendChild(newhand[i].createNode());
                    cardsinhand++;
                }
            }
        }
    </script>

    <script>
        function updateStoppage () {
            var call;
            readFirebase("call", function(snapshot){
                call = snapshot.val().currentCall;
                var node = document.createTextNode (call);
                var element = document.getElementById("call1");
                while (element.firstChild) {
                    element.removeChild(element.firstChild);
                }
                element.appendChild (node);
            });

            if (call == "" && cardsinhand > 0) {
                document.getElementById("BSButton").style.visibility = "visible";
                document.getElementById("SpotButton").style.visibility = "visible";
            }
            else {
                document.getElementById("BSButton").style.visibility = "hidden";
                document.getElementById("SpotButton").style.visibility = "hidden";

                // A method goes here
                // Unfinished

            }
        }
    </script>

    <script>
        function callBS () {
            writeFirebase("call", {currentCall:username+" called BS"});
        }
        function callSPOTON () {
            writeFirebase("call", {currentCall:username+" called SPOT ON"});
        }
    </script>

    <script>
        /*
        function getEveryCard () {
            readFirebase ("/", function (snapshot) {
                var snap = snapshot.val().online.currentusers;
                var i = 0;
                for (k in snap) {
                    //console.log (k);
                    //console.log (snap[k]);
                    if (snapshot.val().currentusers[k] == true) {

                        allusers.push(k);
                        var myNode = document.getElementById("user" + i);
                        while (myNode.firstChild) {
                            myNode.removeChild(myNode.firstChild);
                        }
                        myNode.appendChild(document.createTextNode(k + " : "));
                        i++;
                    }
                }
                while (i < maxplayers) {
                    var myNode = document.getElementById("user" + i);
                    while (myNode.firstChild) {
                        myNode.removeChild(myNode.firstChild);
                    }
                    i++;
                }
            });
        }
        */
    </script>



    <script>
        function checkConnections () {
            allusers = [];
            readFirebase ("online/", function (snapshot) {
                var snap = snapshot.val().currentusers;
                var i = 0;
                for (k in snap) {
                    //console.log (k);
                    //console.log (snap[k]);
                    if (snapshot.val().currentusers[k] == true) {

                        allusers.push(k);
                        var myNode = document.getElementById("user" + i);
                        while (myNode.firstChild) {
                            myNode.removeChild(myNode.firstChild);
                        }
                        myNode.appendChild(document.createTextNode(k + " : "));
                        i++;
                    }
                }
                while (i < maxplayers) {
                    var myNode = document.getElementById("user" + i);
                    while (myNode.firstChild) {
                        myNode.removeChild(myNode.firstChild);
                    }
                    i++;
                }
            });
            checkEveryCard();
        }
    </script>

    <script>
        // Error in here
        function checkEveryCard () {
            for (var i = 0; i < maxplayers; i++) {
                var tempdoc = document.getElementById("user" + i);
                if (tempdoc != null) {

                    var text = tempdoc.textContent;
                    if (text.indexOf(':') != -1) {
                        //console.log (text);
                        var handsize;

                        var tempusername = text.substring(0, text.indexOf(':') - 1);
                        //console.log(tempusername);
                        readFirebase("users/" + tempusername, function (snapshot) {
                            var playerhands = snapshot.val().hand;
                            handsize = numCards(playerhands);
                            while (tempdoc.firstChild) {
                                tempdoc.removeChild(tempdoc.firstChild);
                            }
                            tempdoc.appendChild(document.createTextNode(tempusername + " : " + handsize));
                        });
                    }
                    else {
                        while (tempdoc.firstChild) {
                            tempdoc.removeChild(tempdoc.firstChild);
                        }
                    }
                }
            }
        }
    </script>

    <script>
        function numCards (hand) {
            var total = 0;
            for (d in hand) {
                if (hand[d].replace(/\s/g, '') != "") {
                    total++;
                }
            }
            return total;
        }
    </script>

    <script>

        var deck, card1, card2;
        deck = new Stack();
        deck.makeDeck(1);
        deck.shuffle(1);

        card1 = deck.deal().toString();
        card2 = deck.deal().toString();
        var cards = [card1, card2];
        var dict = { hand: cards };
        writeFirebase ("users/"+username, dict);

    </script>




</head>

<body>

<h1 width="100"> BS Poker </h1> <!-- header-->

<!-- other players-->

<table width="100%" padding="10">
    <tr>

        <td id="user0" width="12.5%">  </td>
        <td id="user1" width="12.5%">  </td>
        <td id="user2" width="12.5%">  </td>
        <td id="user3" width="12.5%">  </td>
        <td id="user4" width="12.5%">  </td>
        <td id="user5" width="12.5%">  </td>
        <td id="user6" width="12.5%">  </td>
        <td id="user7" width="12.5%">  </td>

    </tr>
</table>


<script>
    checkConnections();
</script>

<script>
    var u = setInterval(checkConnections,30);
    //var v = setInterval(checkEveryCard,30);
</script>

<!-- end other players-->
<hr/>

<!--current call bar -->

<div>
    <table width="100%">
        <form> <!-- <tr> -->

            <td>
                <h1>
                   <!-- CURRENT CALL -->
                    <script>
                        document.write (username);
                    </script>
                </h1>
            </td>
            <td id="call1">

            </td>
            <script>
                //updateStoppage();
                var y = setInterval(updateStoppage,100);
                //clearInterval(y);
            </script>
            <td>
                <form>
                    <td>
                        <button type="button" onclick="callBS()" id="BSButton">  BS </button>
                    </td>
                    <td>
                        <button type="button" onclick="callSPOTON()" id="SpotButton"> SPOT ON </button>
                    </td>

                </form>
            </td>
        <tr>

    </table>
</div>

<!--end -->


<div>
    <table width="100%">
        <tr>

            <td id="card0"></td>
            <td id="card1"></td>
            <td id="card2"></td>
            <td id="card3"></td>
            <td id="card4"></td>
            <td id="card5"></td>

            <script>
                updateCards();
            </script>

            <script>

                var t = setInterval(updateCards,1000);
                //clearInterval(t);
            </script>

        </tr>


    </table>
</div>

<!-- Everyone's cards -->
<div>
    <table width="100%">
        <tr>

            <td id="card00"></td><td id="card01"></td>
            <td id="card02"></td><td id="card03"></td>
            <td id="card04"></td><td id="card05"></td>
            <td id="card06"></td><td id="card07"></td>
            <td id="card08"></td><td id="card09"></td>
            <td id="card10"></td><td id="card11"></td>
            <td id="card12"></td><td id="card13"></td>
            <td id="card14"></td><td id="card15"></td>
            <td id="card16"></td><td id="card17"></td>
            <td id="card18"></td><td id="card19"></td>
            <td id="card20"></td><td id="card21"></td>
            <td id="card22"></td><td id="card23"></td>
            <td id="card24"></td><td id="card25"></td>
            <td id="card26"></td><td id="card27"></td>
            <td id="card28"></td><td id="card29"></td>
            <td id="card30"></td><td id="card31"></td>
            <td id="card32"></td><td id="card33"></td>
            <td id="card34"></td><td id="card35"></td>
            <td id="card36"></td><td id="card37"></td>
            <td id="card38"></td><td id="card39"></td>
            <td id="card40"></td><td id="card41"></td>
            <td id="card42"></td><td id="card43"></td>
            <td id="card44"></td><td id="card45"></td>
            <td id="card46"></td><td id="card47"></td>
            <td id="card48"></td><td id="card49"></td>
            <td id="card50"></td><td id="card51"></td>


            <script>

                //var t = setInterval(updateCards,1000);
                //clearInterval(t);
            </script>

        </tr>


    </table>
    <script>

    </script>
</div>


</body>





</html>